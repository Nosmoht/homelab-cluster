name: sidero-config-dry-run
run-name: "sidero-config-dry-run • ${{ github.event_name }} • ${{ github.ref_name }}"

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  config-dry-run:
    if: ${{ github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Read versions
        id: versions
        shell: bash
        run: |
          set -euo pipefail
          talos_version=$(awk -F'= ' '/^CLUSTER_TALOS_VERSION/ {print $2}' install/versions.mk | tr -d ' ')
          if [ -z "$talos_version" ]; then
            echo "CLUSTER_TALOS_VERSION missing in install/versions.mk" >&2
            exit 1
          fi
          echo "talos_version=$talos_version" >> "$GITHUB_OUTPUT"

      - name: Install talosctl
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL -o /usr/local/bin/talosctl "https://github.com/siderolabs/talos/releases/download/${{ steps.versions.outputs.talos_version }}/talosctl-linux-amd64"
          chmod +x /usr/local/bin/talosctl
          talosctl version --client

      - name: Create env file
        shell: bash
        run: |
          set -euo pipefail
          : "${TALOS_PUBLIC_ENDPOINT:?Missing TALOS_PUBLIC_ENDPOINT GitHub variable}"
          cat > install/.env <<EOF
          CLUSTER_NAME=${CLUSTER_NAME}
          CLUSTER_NODE_IP=${CLUSTER_NODE_IP}
          CLUSTER_INSTALL_DISK=${CLUSTER_INSTALL_DISK}
          CLUSTER_INSTALL_IMAGE_BASE=${CLUSTER_INSTALL_IMAGE_BASE}
          TALOS_NODE_ENDPOINT=${TALOS_PUBLIC_ENDPOINT}
          EOF
          if [ -n "${CLUSTER_ADDITIONAL_SANS:-}" ]; then
            echo "CLUSTER_ADDITIONAL_SANS=${CLUSTER_ADDITIONAL_SANS}" >> install/.env
          fi
          if [ -n "${CLUSTER_ENDPOINT:-}" ]; then
            echo "CLUSTER_ENDPOINT=${CLUSTER_ENDPOINT}" >> install/.env
          fi
        env:
          CLUSTER_NAME: ${{ vars.CLUSTER_NAME }}
          CLUSTER_NODE_IP: ${{ vars.CLUSTER_NODE_IP }}
          CLUSTER_INSTALL_DISK: ${{ vars.CLUSTER_INSTALL_DISK }}
          CLUSTER_INSTALL_IMAGE_BASE: ${{ vars.CLUSTER_INSTALL_IMAGE_BASE }}
          TALOS_PUBLIC_ENDPOINT: ${{ vars.TALOS_PUBLIC_ENDPOINT }}
          CLUSTER_ADDITIONAL_SANS: ${{ vars.CLUSTER_ADDITIONAL_SANS }}
          CLUSTER_ENDPOINT: ${{ vars.CLUSTER_ENDPOINT }}

      - name: Write talosconfig
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "$TALOSCONFIG_B64" | base64 --decode > install/talosconfig
          chmod 600 install/talosconfig
          talosctl --talosconfig install/talosconfig config endpoint "$TALOS_PUBLIC_ENDPOINT"
          talosctl --talosconfig install/talosconfig config node "$TALOS_PUBLIC_ENDPOINT"
        env:
          TALOS_PUBLIC_ENDPOINT: ${{ vars.TALOS_PUBLIC_ENDPOINT }}
          TALOSCONFIG_B64: ${{ secrets.TALOSCONFIG_B64 }}

      - name: Write secrets
        shell: bash
        run: |
          set -euo pipefail
          printf '%s' "$TALOS_BOOTSTRAP_SECRETS_YAML_B64" | base64 --decode > install/secrets.yaml
          chmod 600 install/secrets.yaml
        env:
          TALOS_BOOTSTRAP_SECRETS_YAML_B64: ${{ secrets.TALOS_BOOTSTRAP_SECRETS_YAML_B64 }}

      - name: Run config dry-run
        id: dryrun
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/talos-dry-run
          set +e
          make -C install config-dry-run 2>&1 | tee /tmp/talos-dry-run/raw.txt
          status=${PIPESTATUS[0]}
          set -e
          echo "status=$status" >> "$GITHUB_OUTPUT"

      - name: Extract dry-run summary
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          tr -d '\r' < /tmp/talos-dry-run/raw.txt > /tmp/talos-dry-run/raw.clean
          if grep -q "Dry run summary:" /tmp/talos-dry-run/raw.clean; then
            awk 'f{print} /Dry run summary:/{f=1; print}' /tmp/talos-dry-run/raw.clean > /tmp/talos-dry-run/summary.txt
          else
            tail -n 200 /tmp/talos-dry-run/raw.clean > /tmp/talos-dry-run/summary.txt
          fi

      - name: Redact dry-run output
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          python3 scripts/redact_talos_output.py < /tmp/talos-dry-run/summary.txt > /tmp/talos-dry-run/redacted.txt

      - name: Build PR comment
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        env:
          DRYRUN_STATUS: ${{ steps.dryrun.outputs.status }}
        run: |
          set -euo pipefail
          comment=/tmp/talos-dry-run/comment.md
          echo "<!-- talos-config-dry-run -->" > "$comment"
          echo "### Talos config-dry-run output (redacted)" >> "$comment"
          echo "Exit status: ${DRYRUN_STATUS}" >> "$comment"
          echo "" >> "$comment"
          max_bytes=60000
          size=$(wc -c < /tmp/talos-dry-run/redacted.txt)
          output=/tmp/talos-dry-run/redacted.txt
          if [ "$size" -gt "$max_bytes" ]; then
            head -c "$max_bytes" /tmp/talos-dry-run/redacted.txt > /tmp/talos-dry-run/redacted.trunc
            echo -e "\n... (truncated) ..." >> /tmp/talos-dry-run/redacted.trunc
            output=/tmp/talos-dry-run/redacted.trunc
          fi
          printf '%s\n' '```' >> "$comment"
          cat "$output" >> "$comment"
          printf '%s\n' '```' >> "$comment"

      - name: Find existing comment
        if: ${{ github.event_name == 'pull_request' }}
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "<!-- talos-config-dry-run -->"

      - name: Post PR comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: /tmp/talos-dry-run/comment.md
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace

      - name: Fail if dry-run failed
        if: ${{ steps.dryrun.outputs.status != '0' }}
        shell: bash
        run: |
          exit 1

      - name: Cleanup
        if: ${{ always() }}
        shell: bash
        run: |
          rm -f install/talosconfig install/secrets.yaml install/.env
